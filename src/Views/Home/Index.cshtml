@using System.Security.Claims
@{
    ViewData["Title"] = ViewData["Title"] ?? "Danh sách yêu cầu";
    var emp_id = User.FindFirst(ClaimTypes.NameIdentifier)?.Value
        ?? User.FindFirst("preferred_username")?.Value
        ?? User.FindFirst("upn")?.Value;

    var groupedByType = (Model ?? new List<HomeViewModel>())
        .GroupBy(t => t.Type)
        .OrderBy(g => g.Key);
}

@model IEnumerable<HomeViewModel>

<form method="get" class="row gy-2 align-items-center mb-3" id="requestFilterForm">
    <div class="col-auto">
        <select class="form-select" name="TicketType" id="filterRequestType">
            <option value="">-- Loại yêu cầu --</option>
            @if (ViewBag.TicketTypes != null && ViewBag.TicketTypes is IEnumerable<HPDQ.WebSupport.DataEntitites.CodeDetail>)
            {
                foreach (var item in (ViewBag.TicketTypes as IEnumerable<HPDQ.WebSupport.DataEntitites.CodeDetail>)!)
                {
                    <option value="@item.Code">@item.Description</option>
                }
            }
        </select>
    </div>
    <div class="col-auto">
        <select class="form-select" name="TicketStatus" id="filterStatus">
            <option value="">-- Trạng thái --</option>
            @foreach(var item in Enum.GetValues<HPDQ.WebSupport.DataEntitites.TicketStatus>())
            {
                <option value="@((byte)item)">@item.GetDescription()</option>
            }
        </select>
    </div>
    <div class="col-auto">
        <input type="text" class="form-control" name="SearchText" id="filterRequestId" placeholder="Tìm theo nội dung yêu cầu">
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-search"></i> Tìm kiếm
        </button>
        <a href="#" class="btn btn-secondary" onclick="clearfilter()">Xoá lọc</a>
    </div>
</form>

<div class="contentlist" id="contentlist">
    @foreach (var group in groupedByType)
    {
        <div class="type-group">
            <div class="group-header">
                <span class="chevron">&#9660;</span>
                @group.First().TypeDescription
            </div>
            <hr />
            <div class="item-list">
                @foreach (var model in group)
                {
                    <div class="item" tag="@(model.Id)" tagEMP_ID="@(model.EMP_ID)" tagStatus="@((byte)model.Status)">
                        <div class="card-title text-muted small">
                            <b>#@(model.Code) <br /></b>
                            [@(model.CreatedOn.ToString("HH:mm dd/MM/yyyy"))] @(model.FullName)
                        </div>
                        <div class="text-container">
                            <div class="text-content">@(model.Description)</div>
                            <div class="corner-label @(model.Status == HPDQ.WebSupport.DataEntitites.TicketStatus.Done ? "done" : "")
                                            @(model.Status == HPDQ.WebSupport.DataEntitites.TicketStatus.Closed ? "closed" : "")
                                            @(model.Status == HPDQ.WebSupport.DataEntitites.TicketStatus.InProgress ? "progress" : "")">
                                @(model.Status.GetDescription())
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Modal -->
<div class="modal fade" id="dialogModal" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="myModalLabel">CHI TIẾT YÊU CẦU</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="overflow-y: hidden;">
                <input id="modelTag" type="hidden" />

                <div id="requestDetailModal" class="wrapper">
                    <div id="chatbox" class="content contentlist card">
                    </div>
                    <div class="card wrapperfooter">
                        <div style="min-height: 26px;">
                            <div id="divprocessby" style="display: none;">
                                <table>
                                    <tr>
                                        <td style="font-weight: bold;">Nhân sự xử lý: </td>
                                        <td>
                                            <label id="lblempprocessbyname" style="color: mediumblue; cursor: pointer;"></label>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div style="text-align: left;">
                            <table>
                                <tr>
                                    <td class="footertitle">Thông tin phản hồi</td>
                                    <td style="white-space: nowrap;">
                                        <div id="divattachment"></div>
                                        <img id="imgattachment" src="/img/attachment.png" />
                                    </td>
                                    <td class="footerfuncbutton">
                                        <span id="lblclose" class="function">Đóng</span>
                                        <span id="lblcomplete" class="function">Hoàn thành</span>
                                        <span id="lblaccept" class="function">Tiếp nhận</span>
                                        <span id="lblattach"><i class="fa-solid fa-paperclip"></i> Đính kèm</span>
                                        <input id="fileinput" type="file" multiple style="display: none;" />
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div>
                            <table>
                                <tr>
                                    <td style="width: 100%;">
                                        <textarea id="txtdescription" rows="3" contenteditable="true"></textarea>
                                    </td>
                                    <td style="white-space: nowrap;">
                                        <div>
                                            <input id="btnconfirm" type="button" value="Gửi" />
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="dialogModalImage" tabindex="-1" aria-labelledby="myModalLabelImage" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="max-height: calc(100vh - 150px); overflow-y: auto;">
            <div class="modal-header">
                <h5 class="modal-title" id="myModalLabelImage">HÌNH ẢNH ĐÍNH KÈM</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/contentlist.css" />
    <link rel="stylesheet" href="~/css/home.css" />
    <style type="text/css">
        #dialogModalImage .modal-dialog {
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 90vw;
        }
        #dialogModalImage .modal-content {
            width: fit-content;
        }
        #dialogModal .modal-body {
            padding: 5px;
            border-radius: 5px;
        }

        #dialogModalImage .modal-body > div {
            margin-bottom: 8px;
        }

            #dialogModalImage .modal-body > div:last-child {
                margin-bottom: 0;
            }

        #dialogModalImage .modal-body img {
            border: 2px solid #ddd;
            border-radius: 4px;
            display: block;
            max-width: 100%;
            height: auto;
        }
    </style>
}
@section Scripts {
    <script src="~/js/fileinput.js"></script>
    <script src="~/js/ajaxutil.js"></script>
    <script type="text/javascript">
        function formatDateTime(input) {
            // Normalize to 3-digit milliseconds if needed
            const fixedInput = input.replace(/(\.\d{1,2})(?!\d)/, (match) => {
                return match.padEnd(4, '0'); // e.g., ".17" → ".170"
            });

            const date = new Date(fixedInput);

            if (isNaN(date)) return "Invalid date";

            const pad = n => n.toString().padStart(2, '0');

            const hours = pad(date.getHours());
            const minutes = pad(date.getMinutes());
            const day = pad(date.getDate());
            const month = pad(date.getMonth() + 1); // months are 0-based
            const year = date.getFullYear();

            return `${hours}:${minutes} ${day}/${month}/${year}`;
        }
        function clearfilter() {
            $('#filterRequestType').val('');
            $('#filterStatus').val('');
            $('#filterRequestId').val('');
            $('#requestFilterForm').submit();
        }
        // Hàm Loaded
        $(function () {
            $('#contentlist .item').click(function () {
                if ($(this).attr('tagEMP_ID') != '@emp_id' && $(this).attr('tagStatus') == '1') $('#lblcomplete').show();
                else $('#lblcomplete').hide();
                if ($(this).attr('tagEMP_ID') == '@emp_id' && $(this).attr('tagStatus') == '2') $('#lblclose').show();
                else $('#lblclose').hide();
                $('#divprocessby').hide();
                function loadImages() {
                    $('.content.contentlist div.item').each(function(index, element) {
                        var className = $(`.content.contentlist div.item:eq(${index}) div.corner-label`).attr('class');
                        var bodydata;
                        if (index == 0) {
                            bodydata = {
                                ticketId: $(this).attr('tagId')
                            };
                        } else {
                            bodydata = {
                                commentId: $(this).attr('tagId')
                            };
                        }
                        postData('@HPDQ.WebSupport.Utilities.Globals.DomainAPIUrl/Attachments/Load', '@HPDQ.WebSupport.Utilities.Globals.APIKey', bodydata, function(response) {
                            if (response.data.length > 0) {
                                $(`.content.contentlist div.item:eq(${index}) div.corner-label`).attr('class', className.replace(' disabled', ''));
                                var itemcontainer = $('<div class="itemcontainer"></div>');
                                $(`.content.contentlist div.item:eq(${index})`).append(itemcontainer);
                                $.each(response.data, function(index, value) {
                                    if (!/\.jpe?g$|\.png$/i.test(value.fileName)) {
                                        return true;
                                    }
                                    $.ajax({
                                        url: `@HPDQ.WebSupport.Utilities.Globals.DomainAPIUrl/Upload/Get/${value.fileName}`,
                                        method: 'GET',
                                        headers: {
                                            'X-API-KEY': '@HPDQ.WebSupport.Utilities.Globals.APIKey'
                                        },
                                        dataType: 'json',
                                        success: function(response) {
                                            itemcontainer.append(`<img src="data:image/png;base64,${response.data}" />`);
                                        },
                                        error: function(xhr, status, error) {
                                            console.error('Lỗi:', error);
                                        }
                                    });
                                });
                            }
                        });
                    });
                }
                function loadComments(bodydata, progressbyempid) {
                    postData('@HPDQ.WebSupport.Utilities.Globals.DomainAPIUrl/Comments/Load', '@HPDQ.WebSupport.Utilities.Globals.APIKey', bodydata, function(response) {
                        if (response.errorCode != 0)
                        {
                            window.location.href = '/Home/Index';
                            return;
                        }
                        $.each(response.data, function(index, value) {
                            var className = 'item';
                            if (value.emp_id != '@emp_id') {
                                className = 'item reply';
                            }
                            $('.content.contentlist').append(`<div class="${className}" tagId="${value.id}">
                                <div class="card-title text-muted small">[${formatDateTime(value.createdOn)}] ${value.fullName}</div>
                                <div class="text-container">${value.commentDesc}<div class="corner-label disabled" onclick="showImagePopup(this, false)">Đính kèm</div></div>
                            </div>`);
                        });
                        loadImages();
                        var dialogModal = new bootstrap.Modal(document.getElementById('dialogModal'));
                        $('#txtdescription').val('');
                        if (progressbyempid && progressbyempid != '') {
                            $('#divprocessby').show();
                            $('#lblempprocessbyname').html(progressbyempid);
                        }
                        dialogModal.show();
                    });
                }
                var bodydata = {
                    id: $(this).attr('tag')
                };
                postData('@HPDQ.WebSupport.Utilities.Globals.DomainAPIUrl/Tickets/Load', '@HPDQ.WebSupport.Utilities.Globals.APIKey', bodydata, function(response) {
                    if (response.errorCode != 0)
                    {
                        window.location.href = '/Home/Index';
                        return;
                    }
                    $('.content.contentlist').html('');
                    var className = 'item';
                    if (response.data[0].emp_id != '@emp_id') {
                        className = 'item reply';
                    }
                    $('.content.contentlist').append(`<div class="${className}" tagId="${response.data[0].id}">
                        <div class="card-title text-muted small">[${formatDateTime(response.data[0].createdOn)}] ${response.data[0].fullName}</div>
                        <div class="text-container">${response.data[0].description}<div class="corner-label disabled" onclick="showImagePopup(this, true)">Đính kèm</div></div>
                    </div>`);
                    $('#modelTag').val(bodydata.id);

                    bodydata = {
                        ticketId: $('#modelTag').val()
                    };
                    loadComments(bodydata, response.data[0].progressByEMPFullName);
                });
            });
            $('#btnconfirm').click(function () {
                var desc = $('#txtdescription').val();
                if (!desc || desc == '') return;

                var uploadCompleted = false;
                var files;

                var uploadVal = uploadFileInputs('@HPDQ.WebSupport.Utilities.Globals.DomainAPIUrl/Upload/Upload', '@HPDQ.WebSupport.Utilities.Globals.APIKey', uploadCompleted, files);
                uploadCompleted = uploadVal.uploadCompleted;
                files = uploadVal.files;
                if (uploadCompleted == false) {
                    alert(uploadVal.message);
                    return;
                }

                if (uploadCompleted == false) return;

                var bodydata = {
                    emp_id: '@emp_id',
                    commentDesc: desc,
                    ticketId: $('#modelTag').val(),
                    files: files,
                    fullName: '@Html.Raw(User.FindFirst(ClaimTypes.GivenName)?.Value)'
                };
                postData('@HPDQ.WebSupport.Utilities.Globals.DomainAPIUrl/Comments/Create', '@HPDQ.WebSupport.Utilities.Globals.APIKey', bodydata, function(response) {
                    if (response.errorCode != 0)
                    {
                        alert(response.message);
                        return;
                    }
                    var className = 'item';
                    if (response.data.emp_id != '@emp_id') {
                        className = 'item reply';
                    }
                    $('.content.contentlist').append(`<div class="${className}">
                        <div class="card-title text-muted small">[@DateTime.Now.ToString("HH:mm dd/MM/yyyy")] ${response.data.fullName}</div>
                        <div class="text-container">${response.data.commentDesc}<div class="corner-label">Đính kèm</div></div>
                    </div>`);

                    $('#fileinput').val('');
                    formData = new FormData();
                    $('#divattachment').html(formDataFileLength());
                    $('#txtdescription').val('');
                });
            });
            initFileInput();
            if ('@ViewBag.Type' == '1') {
                $('#lblaccept').on('click', function () {
                    var bodydata = {
                        id: $('#modelTag').val(),
                        status: 1,
                        progressBy_EMP_ID: '@emp_id',
                    };
                    postData('@HPDQ.WebSupport.Utilities.Globals.DomainAPIUrl/Tickets/Update?emp_id=@emp_id', '@HPDQ.WebSupport.Utilities.Globals.APIKey', bodydata, function(response) {
                        if (response.errorCode != 0)
                        {
                            alert(response.message);
                            return;
                        }
                        location.reload();
                    });
                });
                $('#lblaccept').show();
            }
            $('#lblcomplete').on('click', function () {
                var bodydata = {
                    id: $('#modelTag').val(),
                    status: 2,
                };
                postData('@HPDQ.WebSupport.Utilities.Globals.DomainAPIUrl/Tickets/Update?emp_id=@emp_id', '@HPDQ.WebSupport.Utilities.Globals.APIKey', bodydata, function(response) {
                    if (response.errorCode != 0)
                    {
                        alert(response.message);
                        return;
                    }
                    location.reload();
                });
            });
            $('#lblclose').on('click', function () {
                var bodydata = {
                    id: $('#modelTag').val(),
                    status: 3,
                };
                postData('@HPDQ.WebSupport.Utilities.Globals.DomainAPIUrl/Tickets/Update?emp_id=@emp_id', '@HPDQ.WebSupport.Utilities.Globals.APIKey', bodydata, function(response) {
                    if (response.errorCode != 0)
                    {
                        alert(response.message);
                        return;
                    }
                    location.reload();
                });
            });
            document.getElementById('dialogModal').addEventListener('shown.bs.modal', function () {
                var scrollDiv = $('#chatbox');
                scrollDiv.animate({
                  scrollTop: scrollDiv.prop("scrollHeight")
                }, 1000); // 1000ms = 1 giây
                // scrollDiv.scrollTop(scrollDiv.prop("scrollHeight"));
            });
            $('#dialogModal').on('hidden.bs.modal', function () {
                $('#fileinput').val('');
                formData = new FormData();
                $('#divattachment').html(formDataFileLength());
                $('#txtdescription').val('');
            });
            document.getElementById('dialogModalImage').addEventListener('shown.bs.modal', function () {
                this.focus();
            });
            $('#dialogModalImage').on('hidden.bs.modal', function (e) {
                $('#dialogModal').focus();
            });
            $('#txtdescription').on('paste', function(event) {
                var items = (event.originalEvent || event).clipboardData.items;

                if (items.length > 0 && items[0].type.indexOf('text') >= 0) return;

                // Prevent the default paste behavior (which might insert a large image)
                event.preventDefault();

                // Check for an image in the clipboard data
                for (var i = 0; i < items.length; i++) {
                    var file = items[i].getAsFile();

                    // Create a new DataTransfer object
                    var dataTransfer = new DataTransfer();

                    // Add the file to the DataTransfer object
                    dataTransfer.items.add(file);

                    // Get your file input element (assuming it has ID 'your-file-input')
                    var fileInput = document.getElementById('fileinput');

                    // Set the files property of the file input
                    fileInput.files = dataTransfer.files;

                    formData.append("files", file);
                    $('#divattachment').html(formDataFileLength());
                }
            });
            const urlParams = new URLSearchParams(window.location.search);
            const tickettype = urlParams.get('TicketType');
            const ticketstatus = urlParams.get('TicketStatus');
            const searchtext = urlParams.get('SearchText');
            if (tickettype && tickettype != null && tickettype != '') {
                $('#filterRequestType').val(tickettype);
            }
            if (ticketstatus && ticketstatus != null && ticketstatus != '') {
                $('#filterStatus').val(ticketstatus);
            }
            if (searchtext && searchtext != null && searchtext != '') {
                $('#filterRequestId').val(searchtext);
            }

            $('.group-header').on('click', function() {
                $(this).toggleClass('collapsed');
                $(this).nextAll('.item-list').first().slideToggle(300);
            });

            $('.item-list').show();
            $('.group-header').removeClass('collapsed');
        });
        // Hàm Loaded
        function showImagePopup(element, isTicket) {
            var elclass = $(element).attr('class');
            if (elclass.includes('disabled')) return;
            $('#dialogModalImage div.modal-body').html('');
            var bodydata;
            if (isTicket) {
                bodydata = {
                    ticketId: $(element.parentElement.parentElement).attr('tagid')
                };
            } else {
                bodydata = {
                    commentId: $(element.parentElement.parentElement).attr('tagid')
                };
            }
            postData('@HPDQ.WebSupport.Utilities.Globals.DomainAPIUrl/Attachments/Load', '@HPDQ.WebSupport.Utilities.Globals.APIKey', bodydata, function(response) {
                if (response.data.length > 0) {
                    $.each(response.data, function(index, value) {
                        if (!/\.jpe?g$|\.png$/i.test(value.fileName)) {
                            return true;
                        }
                        $.ajax({
                            url: `@HPDQ.WebSupport.Utilities.Globals.DomainAPIUrl/Upload/Get/${value.fileName}`,
                            method: 'GET',
                            headers: {
                                'X-API-KEY': '@HPDQ.WebSupport.Utilities.Globals.APIKey'
                            },
                            dataType: 'json',
                            success: function(response) {
                                $('#dialogModalImage div.modal-body').append(`<div><img src="data:image/png;base64,${response.data}" /></div>`);
                                $('#dialogModalImage').focus();
                            },
                            error: function(xhr, status, error) {
                                console.error('Lỗi:', error);
                            }
                        });
                    });
                }
            });
            var dialogModalImage = new bootstrap.Modal(document.getElementById('dialogModalImage'), { backdrop: true, keyboard: true });
            dialogModalImage.show();
        }
    </script>
}